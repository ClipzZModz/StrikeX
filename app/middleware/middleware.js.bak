var sql         = require("../storage/database.js");
var moment      = require("moment");

module.exports = {

    /* ------------------------------------------------------- */
    //                                                         //
    //                 Check the request for a ref             //
    //                    and log if it exists                 //  
    //                                                         //
    /* ------------------------------------------------------- */

    getRef: function(req, res, next){

        if(!req.query.ref) return next();
        next();

        sql.query(`SELECT * FROM referrals WHERE refCode = ?`, [req.query.ref], function(err, results) {
            if(err) throw err;

            if(results.length === 0) return res.redirect(`${req.originalUrl.split('?')[0]}`); // redirect the user to the same page but without the ref code 

            sql.query(`INSERT INTO referral_data (linked_id, ip_address, url, time) VALUES (?, ?, ?, ?)`, [results[0].refCode, req.headers["x-forwarded-for"] || req.socket.remoteAddress, req.originalUrl, moment().format()], function(err) {
                if(err) throw err;
            });

        });
        
    },

    ////////////


    getVisit: function(req, res, next){

        next();

        const url = new URL(`${req.protocol}://${req.get('host')}${req.originalUrl}`);

        sql.query(`INSERT INTO visit_data (ip, date, ref, page, full_url) VALUES (?, ?, ?, ?, ?)`, [req.headers["x-forwarded-for"] || req.socket.remoteAddress, moment().format(), req.query.ref, req.originalUrl, url.href], function(err) {
            if(err) throw err;
            
            const { Webhook } = require('discord-webhook-node');
            const { lookup } = require('geoip-lite');
            const hook = new Webhook("https://discord.com/api/webhooks/1040730660794548264/2nZXDjdTAe92BRKS9eWIVAoBWfc3oa7tlu2kJ3LDCB55P-ntJA1_lOAxixfEOqDlYd8c");

            let mobile = req.useragent.isMobile;
            if(mobile === undefined) mobile = false;

            //

            let ref = req.query.ref;
            if(ref === undefined) ref = 'Direct'

            try {
                hook.send(`[${moment().format('MMMM Do YYYY, h:mm:ss a')}]:\`\`\`URL: ${url.href}\nIP: ${req.headers["x-forwarded-for"] || req.socket.remoteAddress}\nRef: ${ref}\nCountry: ${lookup(req.headers["x-forwarded-for"] || req.socket.remoteAddress).timezone} / ${lookup(req.headers["x-forwarded-for"] || req.socket.remoteAddress).city}\nMobile: ${mobile}\`\`\``);
            } catch(e) {
                return;
            }

        });

        
    },

}