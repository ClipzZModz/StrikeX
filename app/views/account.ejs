<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0">
  <link rel="stylesheet" href="/css/vendor/font-awesome.min.css">
  <link rel="stylesheet" href="/css/vendor/simple-line-icons.css">
  <link rel="stylesheet" href="/css/vendor/magnific-popup.css">
  <link rel="stylesheet" href="/css/style.min.css">
  <link rel="icon" href="/favicon.ico">
  <title>StrikeX | Account</title>
</head>
<body class="account-page">
  <%- include('partials/main/storefront_header') %>

  <div class="section-navigation-wrap">
    <div class="section-navigation">
      <p class="section-navigation-path">
        <span class="path">Home</span>
        <span class="path bold">
          <svg class="svg-arrow tiny"><use xlink:href="#svg-arrow"></use></svg>
        </span>
        <span class="path current">My Account</span>
      </p>
    </div>
  </div>

  <div class="section-wrap">
    <div class="section no-title account-section">
      <div class="account-layout">
        <aside class="account-sidebar">
          <div class="sidebar-widget">
          <h2 class="subsection-title">Welcome Back</h2>
          <hr class="line-separator">
          <ul class="widget-dropdown">
            <li class="widget-dropdown-item"><a href="#profile">Profile</a></li>
            <li class="widget-dropdown-item"><a href="#orders">Orders</a></li>
            <li class="widget-dropdown-item"><a href="#addresses">Addresses</a></li>
          </ul>
          </div>
        </aside>

        <div class="account-content">
        <h2 class="subsection-title" id="profile">Profile</h2>
        <hr class="line-separator">
        <p class="small">Keep your details updated for faster checkout.</p>
        <div class="details-list">
          <div class="details-list-item">
            <h6 class="details-list-title">Account Details</h6>
            <p class="details-list-info"><span>Name:</span> <%= user?.firstName || '' %> <%= user?.lastName || '' %></p>
            <p class="details-list-info"><span>Email:</span> <%= user?.email || '' %></p>
            <% if (user?.company) { %>
              <p class="details-list-info"><span>Company:</span> <%= user.company %></p>
            <% } %>
          </div>
        </div>

        <h2 class="subsection-title" id="orders" style="margin-top:60px;">Orders</h2>
        <hr class="line-separator">
        <% if (orders && orders.length) { %>
          <div class="account-orders">
            <table class="account-table">
              <thead>
                <tr>
                  <th>Order</th>
                  <th>Date</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% orders.forEach((order) => { %>
                  <tr>
                    <td>#<%= order.id %></td>
                    <td><%= moment(order.date).format('DD MMM YYYY') %></td>
                    <td class="account-table-total"><%= order.total %></td>
                    <td class="account-table-status"><%= order.status %></td>
                    <td><a class="button small" href="/order/<%= order.id %>">View</a></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="product-description">No orders yet.</p>
        <% } %>

        <h2 class="subsection-title" id="addresses" style="margin-top:60px;">Addresses</h2>
        <hr class="line-separator">
        <% if (addresses && addresses.length) { %>
          <div class="details-list">
            <% addresses.forEach((addr) => { %>
              <div class="details-list-item">
                <h6 class="details-list-title"><%= addr.is_default ? 'Default Address' : 'Address' %></h6>
                <p class="details-list-info"><span>Name:</span> <%= addr.full_name %></p>
                <% if (addr.phone_number) { %>
                  <p class="details-list-info"><span>Phone:</span> <%= addr.phone_number %></p>
                <% } %>
                <p class="details-list-info"><span>Address:</span> <%= addr.address_line1 %><% if (addr.address_line2) { %>, <%= addr.address_line2 %><% } %></p>
                <p class="details-list-info"><span>City:</span> <%= addr.city %></p>
                <p class="details-list-info"><span>Region:</span> <%= addr.region || '-' %></p>
                <p class="details-list-info"><span>Postcode:</span> <%= addr.postal_code %></p>
                <p class="details-list-info"><span>Country:</span> <%= addr.country %></p>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p class="product-description">No saved addresses yet.</p>
        <% } %>

        <h3 class="subsection-title" style="margin-top:40px;">Add Address</h3>
        <hr class="line-separator">
        <form id="addAddressForm" class="top-short">
          <div class="form-row">
            <div class="half">
              <label for="addr_full_name" class="rl-label required">Full Name</label>
              <input type="text" id="addr_full_name" name="full_name" required>
            </div>
            <div class="half">
              <label for="addr_phone" class="rl-label">Phone</label>
              <input type="text" id="addr_phone" name="phone_number">
            </div>
          </div>
          <div class="form-row">
            <label for="addr_line1" class="rl-label required">Address Line 1</label>
            <input type="text" id="addr_line1" name="address_line1" required>
            <input type="text" id="addr_line2" name="address_line2" placeholder="Apartment, suite, etc.">
          </div>
          <div class="form-row">
            <div class="half">
              <label for="addr_city" class="rl-label required">City</label>
              <input type="text" id="addr_city" name="city" required>
            </div>
            <div class="half">
              <label for="addr_region" class="rl-label">State / County</label>
              <input type="text" id="addr_region" name="region">
            </div>
          </div>
          <div class="form-row">
            <div class="half">
              <label for="addr_postal" class="rl-label required">Postcode</label>
              <input type="text" id="addr_postal" name="postal_code" required>
            </div>
            <div class="half">
              <label for="addr_country" class="rl-label required">Country</label>
              <input type="text" id="addr_country" name="country" required>
            </div>
          </div>
          <div class="form-row">
            <input type="checkbox" id="addr_default" name="is_default" value="true" checked>
            <label class="checkbox" for="addr_default">
              <span class="box">
                <svg class="svg-check"><use xlink:href="#svg-check"></use></svg>
              </span>
              Set as default address
            </label>
          </div>
          <div class="form-row">
            <p id="addressMessage" class="small" style="color:#fa4f09;"></p>
            <button class="button" type="submit">Save Address</button>
          </div>
        </form>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/vendor/jquery-3.1.0.min.js"></script>
  <script src="/js/vendor/jquery.magnific-popup.min.js"></script>
  <script src="/js/vendor/imgLiquid-min.js"></script>
  <script src="/js/liquid.js"></script>
  <script src="/js/dropdowns.js"></script>
  <script src="/js/popups.js"></script>
  <script>
    (function () {
      const form = document.getElementById('addAddressForm');
      const message = document.getElementById('addressMessage');
      if (!form) return;

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (message) message.textContent = '';

        const data = Object.fromEntries(new FormData(form).entries());
        data.is_default = form.querySelector('#addr_default')?.checked || false;

        try {
          const response = await fetch('/addresses/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || 'Unable to save address');
          }
          if (message) {
            message.style.color = '#4CAF50';
            message.textContent = result.message || 'Address saved.';
          }
          setTimeout(() => window.location.reload(), 600);
        } catch (err) {
          if (message) {
            message.style.color = '#fa4f09';
            message.textContent = err.message || 'Unable to save address.';
          }
        }
      });
    })();
  </script>
</body>
</html>
