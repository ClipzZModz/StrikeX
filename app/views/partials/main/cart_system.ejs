    <!-- Cart Sidebar -->
    <div id="cartSidebar" class="cart-sidebar">
        <div class="cart-header">
        <h4>Your Cart</h4>
        <button id="closeCart" class="close-cart">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
        <!-- JS will populate cart items here -->
        </div>
        <div class="cart-footer">
        <strong>Total:</strong> <span id="cartTotalSidebar">&pound;0.00</span>
        <a href="/cart" class="checkout-btn">Checkout</a>
        </div>
    </div>
    

    <script>
        if (window.__cartSystemInitialized) {
          // Avoid double-initialization if included more than once.
        } else {
        window.__cartSystemInitialized = true;

        const cartButtons = Array.from(document.querySelectorAll('[data-cart-toggle="true"]'));
        const cartSidebar = document.getElementById('cartSidebar');
        const closeCartBtn = document.getElementById('closeCart');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTotalHeader = document.getElementById('cartTotal');
        const cartTotalSidebar = document.getElementById('cartTotalSidebar');
        const cartTotalEls = Array.from(document.querySelectorAll('.cart-total'));
        const cartCountEls = Array.from(document.querySelectorAll('.cart-count'));
      
        let cart = [];
      
        const addItemToCart = (cartData) => {
            if (!cartData || !cartData.lines || !Array.isArray(cartData.lines.edges)) {
                console.error('Invalid cart data structure:', cartData);
                return;
            }

            console.log('Updated cart data from server:', cartData);

            cart = cartData.lines.edges.map(edge => {
                const item = edge.node;

                console.log('Cart item:', item);

                const price = parseFloat(item.price);
                const quantity = parseInt(item.quantity);

                return {
                name: item.title || 'Unnamed Product',
                price: !isNaN(price) ? price : 0,
                qty: !isNaN(quantity) ? quantity : 1,
                img: item.image || 'assets/images/default.jpg'
                };
            });

            renderCart();
            toggleCart(true);
            };

            const hydrateCartFromServer = (items) => {
                if (!Array.isArray(items) || items.length === 0) return;

                cart = items.map(item => ({
                    name: item.title || item.name || 'Unnamed Product',
                    price: parseFloat(item.price) || 0,
                    qty: parseInt(item.quantity, 10) || 1,
                    img: item.image || 'assets/images/default.jpg'
                }));

                renderCart();
            };

                
            const renderCart = async () => {

                let currencyCode = 'GBP';

                cartItemsContainer.innerHTML = '';
                let total = 0;

                for (const { name, price, img, qty } of cart) {
                    let finalPrice = price;
                    let finalQty = qty;

                    if (typeof finalPrice !== 'number' || isNaN(finalPrice)) finalPrice = 0;
                    if (typeof finalQty !== 'number' || isNaN(finalQty)) finalQty = 1;

                    const item = document.createElement('div');
                    item.className = 'cart-item';


                    try {
                    const response = await fetch(`/checkout/product/${encodeURIComponent(name)}`, {
                        method: 'GET',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const result = await response.json();
                    const priceAmount = parseFloat(JSON.parse(result.productData[0].uk_price_obj).price.amount);

                    item.innerHTML = `
                        <img src="${img}" alt="${name}" />
                        <div class="cart-item-details">
                        <strong>${name}</strong><br>
                        &pound;${priceAmount.toFixed(2)} GBP x ${finalQty}
                        </div>
                    `;


                    cartCountEls.forEach((el) => {
                      el.innerHTML = result.totalCartItems;
                    });

                    total += priceAmount * finalQty;
                    cartItemsContainer.appendChild(item);

                    } catch (error) {
                    console.error('Fetch error:', error);
                    }
                }

                if (cartTotalHeader) {
                  cartTotalHeader.textContent = `\u00a3${total.toFixed(2)}`;
                }
                if (cartTotalSidebar) {
                  cartTotalSidebar.textContent = `\u00a3${total.toFixed(2)}`;
                }
                cartTotalEls.forEach((el) => {
                  el.textContent = `\u00a3${total.toFixed(2)}`;
                });
                };

      
        const toggleCart = (show = false) => {
          if (show) {
            cartSidebar.classList.add('open');
          } else {
            cartSidebar.classList.remove('open');
          }
        };
      
        cartButtons.forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleCart(true);
          });
        });

        if (closeCartBtn) {
          closeCartBtn.addEventListener('click', () => toggleCart(false));
        }

        document.addEventListener('mousedown', (event) => {
          if (!cartSidebar.classList.contains('open')) return;

          const clickedInsideSidebar = cartSidebar.contains(event.target);
          const clickedCartButton = cartButtons.some((btn) => btn.contains(event.target));

          if (!clickedInsideSidebar && !clickedCartButton) {
            toggleCart(false);
          }
        });
      
        const addToCart = async (variantId, quantity = 1) => {
          try {

            const response = await fetch('/api/v1/cart/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ variantId, quantity })
            });
      
            const result = await response.json();
      
            if (response.ok) {
              console.log('Cart updated:', result);
              addItemToCart(result.cart);
            } else {
              console.error('Failed to add item to cart:', result.error);
              alert(`Error: ${result.error}`);
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            alert('An unexpected error occurred. Please try again later.');
          }
        };
                          
            


        window.addToCart = addToCart;
        window.toggleCart = toggleCart;

        document.addEventListener('DOMContentLoaded', () => {
          if (window.cartItemsFromServer) {
            hydrateCartFromServer(window.cartItemsFromServer);
          }
        });
        }
      </script>